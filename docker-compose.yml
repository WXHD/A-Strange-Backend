# 服务（容器）列表
services:
  # pq数据库
  postgres:
    # 指定从./Dockerfile文件构建镜像
    build:
      context: ./postgresql-test
      dockerfile: Dockerfile
    # 容器名称
    container_name: my_postgres
    environment:
      POSTGRES_DB: postgresql
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: wxhd
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    # # 主机端口:容器端口 # 取消端口暴露防止外部访问
    # ports:
    #   - "10010:5432"
    # 挂载目录
    volumes:
      # 数据目录 由docker自动管理
      - my_postgres_data:/var/lib/postgresql/data
      # 备份目录 当前目录下的backups目录映射到容器的/backups目录
      - ./postgresql-test/backups:/backups
    # 网络
    networks:
      - my_postgres_net
    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # 后端服务
  backend:
    build:
      context: ./fastapi-backend-test
      dockerfile: Dockerfile
    container_name: my_backend
    # 允许外部访问后端端口
    ports:
      - "10011:10011"
    # 确保数据库先启动
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - my_postgres_net
  
  # 前端服务
  frontend:
    build:
      context: ./react-frontend-test
      dockerfile: Dockerfile
    container_name: my_frontend
    ports:
      - "10012:80"
    environment:
      - NODE_ENV=production
    networks:
      - my_postgres_net
    depends_on:
      backend:
        condition: service_started

# 声明持久化数据卷
volumes:
  my_postgres_data:

# 声明网络
networks:
  my_postgres_net:
    driver: bridge